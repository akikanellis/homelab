---
services:
  gluetun:
    image: qmcgaw/gluetun:v3.36.0@sha256:011bea4f0743864d4eda5a569217a6fe18e3a52f5d6df31b4ceb9f7763bfbf6b # editorconfig-checker-disable-line
    environment:
      TZ: "{{ timezone }}"

      FIREWALL_OUTBOUND_SUBNETS: "{{ network_subnet }}"
      OPENVPN_PASSWORD: "{{ openvpn_password }}"
      OPENVPN_USER: "{{ openvpn_user }}"
      SERVER_COUNTRIES: United Kingdom
      VPN_SERVICE_PROVIDER: "{{ vpn_provider }}"
    volumes:
      - "{{ volumes_directory }}/gluetun/gluetun:/gluetun"
      # We need to override the resolv.conf due to a bug in gluetun.
      # See: https://github.com/qdm12/gluetun/issues/281
      - "{{ volumes_directory }}/gluetun/etc-resolv.conf:/etc/resolv.conf:ro"
    ports:
      # prowlarr
      - "9696:9696"

      # qbittorrent
      - "6881:6881"
      - "6881:6881/udp"
      - "28080:28080"

      # radarr
      - "7878:7878"

      # sabnzbd
      - "18080:8080"

      # sonarr
      - "18989:8989"
      - "19090:9090"
    cap_add:
      - NET_ADMIN
    restart: always

  plex:
    image: lscr.io/linuxserver/plex:1.32.7@sha256:56d4304302cb2bb87a5ebe7b8c3d2f4caf47dcb1ddb8ac3613920d89440961df # editorconfig-checker-disable-line
    environment:
      TZ: "{{ timezone }}"

      PUID: "{{ ansible_admin_user_uid }}"
      PGID: "{{ ansible_admin_user_gid }}"
    volumes:
      - "{{ volumes_directory }}/plex/config:/config"

      - "{{ media_directory }}/tv:/tv"
      - "{{ media_directory }}/movies:/movies"
    devices:
      - /dev/dri:/dev/dri
    network_mode: host
    healthcheck:
      test: >
        (curl -f http://localhost:32400/identity && curl -f api.ipify.org) ||
        exit 1
      interval: 10s
      timeout: 1s
      retries: 3
      start_period: 60s
    restart: always

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:1.10.5@sha256:c99aff42186aa7f14f4f62a1f31b9e637d16ce63c3af3b91b8c90d678bfcaad8 # editorconfig-checker-disable-line
    environment:
      TZ: "{{ timezone }}"

      PUID: "{{ ansible_admin_user_uid }}"
      PGID: "{{ ansible_admin_user_gid }}"
    volumes:
      - "{{ volumes_directory }}/prowlarr/config:/config"
    network_mode: service:gluetun
    healthcheck:
      test: (curl -f http://localhost:9696 && curl -f api.ipify.org) || exit 1
      interval: 10s
      timeout: 1s
      retries: 3
      start_period: 60s
    restart: always

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:4.6.1@sha256:761310c8f0165ee9277ccf0e236a9132a0f932b005149aa7717cdeef8bdb7de3 # editorconfig-checker-disable-line
    environment:
      TZ: "{{ timezone }}"

      PUID: "{{ ansible_admin_user_uid }}"
      PGID: "{{ ansible_admin_user_gid }}"

      WEBUI_PORT: 28080
    volumes:
      - "{{ volumes_directory }}/qbittorrent/config:/config"

      - "{{ downloads_directory }}/torrents:/downloads"
    network_mode: service:gluetun
    healthcheck:
      test: (curl -f http://localhost:28080 && curl -f api.ipify.org) || exit 1
      interval: 10s
      timeout: 1s
      retries: 3
      start_period: 60s
    restart: always

  radarr:
    image: lscr.io/linuxserver/radarr:5.1.3@sha256:ee96728ead2d3e6d7ccd32a96e16c13ea3818ffa7579fb0c11fe205f9733ae74 # editorconfig-checker-disable-line
    environment:
      TZ: "{{ timezone }}"

      PUID: "{{ ansible_admin_user_uid }}"
      PGID: "{{ ansible_admin_user_gid }}"
    volumes:
      - "{{ volumes_directory }}/radarr/config:/config"

      - "{{ downloads_directory }}:/downloads"
      - "{{ media_directory }}/movies:/movies"
    network_mode: service:gluetun
    healthcheck:
      test: (curl -f http://localhost:7878 && curl -f api.ipify.org) || exit 1
      interval: 10s
      timeout: 1s
      retries: 3
      start_period: 60s
    restart: always

  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:4.1.0@sha256:c2ef513dfd4d23fc19cf529029e7ee293ac4980e41fd132a87adecfb2a12f920 # editorconfig-checker-disable-line
    environment:
      TZ: "{{ timezone }}"

      PUID: "{{ ansible_admin_user_uid }}"
      PGID: "{{ ansible_admin_user_gid }}"
    volumes:
      - "{{ volumes_directory }}/sabnzbd/config:/config"

      - "{{ downloads_directory }}/usenet/complete:/downloads"
      - "{{ downloads_directory }}/usenet/temp:/incomplete-downloads"
    network_mode: service:gluetun
    healthcheck:
      test: (curl -f http://localhost:8080 && curl -f api.ipify.org) || exit 1
      interval: 10s
      timeout: 1s
      retries: 3
      start_period: 60s
    restart: always

  sonarr:
    image: lscr.io/linuxserver/sonarr:3.0.10@sha256:3e25bfa2304448e26d43bf09e6291b238c43db897764846b084f2f3f1176c40f # editorconfig-checker-disable-line
    environment:
      TZ: "{{ timezone }}"

      PUID: "{{ ansible_admin_user_uid }}"
      PGID: "{{ ansible_admin_user_gid }}"
    volumes:
      - "{{ volumes_directory }}/sonarr/config:/config"

      - "{{ downloads_directory }}:/downloads"
      - "{{ media_directory }}/tv:/tv"
    network_mode: service:gluetun
    healthcheck:
      test: (curl -f http://localhost:8989 && curl -f api.ipify.org) || exit 1
      interval: 10s
      timeout: 1s
      retries: 3
      start_period: 120s
    restart: always
